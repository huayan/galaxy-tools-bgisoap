<tool id="soapsnp" name="SOAPsnp" version="0.1">
    <requirements>
        <requirement type="package">bgisoap</requirement>
    </requirements>
    <description>- assemble a consensus sequence and identify SNPs
    </description>
    <command interpreter="python">
        soapsnp.py --alignment=$alignment --refgenome=$refgenome  --qualityscore=$qualityscore --gedc=$gedc
        --pcr_coefficient=$pcr_coefficient --althom=$althom --het=$het --hetprior=$hetprior --althomprior=$althomprior
        --unvalidated_hetprior=$unvalidated_hetprior --unvalidated_althomrate=$unvalidated_althomrate
        --fastq_score=$fastq_score --output_format=$output_format --output=$output
    </command>
    <inputs>
        <!-- Mandatory paramenters -->
        <param name="alignment" type="data" format="input" label="Sorted short read alignment" optional="false"
               help="Sequence alignments must be sorted by chromosome name in alphabetical order and then by coordinates in numerical order on each chromosome."/>
        <param name="refgenome" type="data" format="fasta" label="Reference genome in FASTA format" optional="false"/>
        <!-- Optional parameters -->
        <param name="qualityscore" type="text" label="Quality score" value="0"
               help="A character defining the quality score for a base call. FASTQ files generated by the Illumina base-calling pipeline use ‘@’ as 0. Some organisations use ‘!’ as 0."/>
        <param name="gedc" type="float" label="Global error dependency coefficient" value="0.9"/>
        <param name="pcr_coefficient" type="float" label="PCR error dependency coefficient" value="0.5" optional="true"
               help="Sequencing errors maybe repetitive in nature and are not complete independent of each other. The main source of repeatable errors is believed to be PCR amplification in the sequencing process. The proper values of the above two parameters rely on the wetlab process. Nonetheless, the default value generally works most of time."/>
        <param name="althom" type="float" label="Novel altHOM prior probability" value="0.0005" optional="true"/>
        <param name="het" type="float" label="Novel HET prior probability" value="0.0010" optional="true"
               help="The two above parameters define the prior probabilities of homozygous SNPs (altHOM) and heterozygous SNPs (HET), which are used in the Bayes formula calculation. Note these are prior probabilities of a new SNP and are expected to be stringent. For different species, these two values should be modified accordingly."/>
        <!-- This is causing problems with specifying a boolean value in Galaxy
        <param name="ratio" type="boolean" label="Transition/transversion ratio" value="true" checked="true" optional="true"/>
        -->
        <!-- This parameter will probably cause problems so leaving it out now for time being
        <param name="SNP_information" type="data" label="Pre-formatted known SNP information"
               help="This information should be in the format: chr1    201979756       1       1       0       0.161   0       0       0.839   rs568. The columns from left to right are: chromosome name, chromosome co-ordinate, SNP allele frequency information (1 = true, 0 = false), whether SNP is validated by experiment (1 is true, 0 is false), whether the SNP is actually an indel (1 is true, 0 is false), frequency of A, frequency of C, frequency of T, frequency of G, SNP ID. For known SNP sites that do not have allele frequency information, the frequency information can be arbitrarily determined as any positive values, which implies what alleles have already been deposited in the database."/>
         -->
        <!-- Requires a boolean value to be passed, problematic so leaving it out
        <param name="refinesnp" type="text" label="Refine SNP" value="Off"
               help="Refine SNP calling using known SNP information"/>
         -->
        <param name="hetprior" type="float" label="Validated HET prior" value="0.1" optional="true"
               help="Validated HET prior, if no allele frequency known"/>
        <param name="althomprior" type="float" label="Validated altHOM prior" value="0.05" optional="true"
               help="Validated altHOM prior, if no allele frequency known"/>
        <param name="unvalidated_hetprior" type="float" label="Validated altHOM prior" value="0.02" optional="true"
               help="Unvalidated HET prior, if no allele frequency known"/>
        <param name="unvalidated_althomrate" type="float" label="Unvalidated altHOM rate, if no allele frequency known"
               value="0.01" optional="true"
               help="The above four parameters are related to using external SNP information to alter prior probabilities for SNP calling. SOAPsnp will use allele frequency information as prior probability in calling genotypes for each site. If the allele frequency information is absent, it will use the above 4 parameters as prior probability."/>
        <!-- boolean parameter ignore for now
        <param name="ranksum" type="text" label="Enable rank sum test" value="Off"
               help="Checks whether the two alleles of a possible HET call can have the same sequencing quality to give HET a further penalty for better accuracy."/>
        -->
        <!--
        <param name="calibration_matrix" type="data" label="Previous quality calibration matrix"
               value="Off" help="This parameter cannot be used simutaneously with -M"/>
         -->
        <!-- boolean parameter ignore for now
        <param name="binomial_prob" type="text" label="Enable binomial probability calculation" value="Off"
               help="Checks whether two alleles are observed equally to give HET a further penalty for better accuracy."/>
        -->
        <!-- boolean parameter ignore for now
        <param name="monoploid" type="text" label="Enable monoploid calling mode" value="Off"
               help="Ensures all consensus as HOM and you probably should specify higher altHOM rate."/>
        -->
        <!-- boolean parameter ignore for now
        <param name="output_snps" type="text" label="Output only potential SNPs" value="Off"/>
        -->
        <!-- Best to not use this parameter in case it causes soapsnp to crash
        <param name="readlength" type="integer" label="Maximum length of read" value="45" optional="true"
               help="Please note that once length of some reads exceeds the parameter, it will probably crash the program"/>
         -->
        <param name="fastq_score" type="integer" label="Maximum FASTQ quality score" value="40" optional="true"/>
        <param name="output_format" type="text" label="Output format" value="0" optional="true" help="0=Text; 1=GLFv2; 2=GPFv2"/>
        <!-- Not implemented
        <param name="extra_headers" type="text" label="Extra headers EXCEPT CHROMOSOME FIELD specified in GLFv2 output. Format is
	TypeName1:DataName1:TypeName2:DataName2" value="0" optional="true"/>
        <param name="call_consensus_on_regions" type="data" label="Only call consensus on regions specified in FILE. Format of this file is:
	ChrName\tStart\tEnd ChrName\tStart\tEnd …" value="0" optional="true"/>
	    -->
    </inputs>
    <outputs>
        <!-- Not implemented
        <param name="calibration_matrix" type="data" label="Output quality calibration matrix" value="Off"/>
        -->
        <data format="tabular" name="output">
            <change_format>
                <when input="interval" value="Yes" format="interval"/>
            </change_format>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="alignment" value="bgisoap/test.soap.sorted"/>
            <param name="refgenome" value="bgisoap/ref.fa"/>
            <output name="output" file="bgisoap/test.consensus"/>
        </test>
    </tests>
    <help>
**What it does**

SOAPsnp is a resequencing utility that assembles a consensus sequence for the genome of a newly sequenced
organism based on the alignment of the raw sequencing reads on the known reference genome. The SNPs can then be
identified on the consensus sequence through comparison with the reference. SOAPsnp uses a method based on
Bayes’ theorem (the reverse probability model) to call consensus genotype by carefully considering the data
quality, alignment, and recurring experimental errors. All these kinds of information was integrated into a
single quality score for each base in PHRED scale to measure the accuracy of consensus calling. Currently, it
supports the alignment format of SOAPaligner.
    </help>
</tool>
