<tool id="soapdenovo2" name="SOAPdenovo2" version="0.1">
    <description>- perform de novo genome assembly</description>
    <requirements>
        <requirement type="package">bgisoap</requirement>
    </requirements>
    <command interpreter="python">
        soapdenovo2.py

        ## Parameters required in config file
        ## Maximum read length
        --max_read_length=$max_read_length

        #for $i in $libraries
            ##[LIB]
            ## Average insert size
            --avg_ins=$i.avg_ins
            ## Reverse sequence?
            --reverse_seq=$i.reverse_seq
            ## Read operations
            --asm_flags=$i.asm_flags
            ## Use only first 100 bps of each read
            --rd_len_cutoff=$i.rd_len_cutoff
            ## Rank
            --rank=$i.rank
            ## The cutoff of a pair number for a reliable connection (at least 3 for short insert size)
            --pair_num_cutoff=$i.pair_num_cutoff
            ## Minimum aligned length to contigs for a reliable read location (at least 32 for short insert size)
            --map_len=$i.map_len

            ## Check if using single or paired reads
            --type_of_data=$i.data_type.single_paired
            #if $i.data_type.single_paired == "single"
                --format_of_data=$i.data_type.data_format.fastq_fasta
                #if $i.data_type.data_format.fastq_fasta == "fastq"
                    --single_fastq_input1=$i.data_type.data_format.input1
                #else if $i.data_type.data_format.fastq_fasta == "fasta"
                    --single_fasta_input1=$i.data_type.data_format.input1
                #else
                    --single_bam_input1=$i.data_type.data_format.input1
                #end if
            #else
                --format_of_data=$i.data_type.data_format.fastq_fasta
                #if $i.data_type.data_format.fastq_fasta == "fastq"
                    --paired_fastq_input1=$i.data_type.data_format.input1
                    --paired_fastq_input2=$i.data_type.data_format.input2
                #else if $i.data_type.data_format.fastq_fasta == "fasta"
                    --paired_fasta_input1=$i.data_type.data_format.input1
                    --paired_fasta_input2=$i.data_type.data_format.input2
                #else
                    --paired_bam_input1=$i.data_type.data_format.input1
                    --paired_bam_input2=$i.data_type.data_format.input2
                #end if
            #end if
        #end for

        ## Check if using default or custom parameters
        --default_full_settings_type=$default_full_settings.settings_type
        #if $default_full_settings.settings_type == "full"
            --kmer_size=$kmer_size
            --ncpu=$ncpu
            --init_mem_assumption=$init_mem_assumption
            --kmer_freq_cutoff=$kmer_freq_cutoff
            --resolve_repeats=$resolve_repeats
            --edge_cov_cutoff=$edge_cov_cutoff
            --merge_level=$merge_level
            --max_k=$max_k
            --weight=$weight
            --keep_avail_read=$keep_avail_read
            --merge_clean_bubble=$merge_clean_bubble
            --output_gap_related_reads=$output_gap_related_reads
            --kmer_r2c=$kmer_r2c
            --fill_gaps=$fill_gaps
            --unmask_contigs=$unmask_contigs
            --keep_contigs_connected=$keep_contigs_connected
            --gap_len_diff=$gap_len_diff
            --min_contig_len=$min_contig_len
            --min_contig_cvg=$min_contig_cvg
            --max_contig_cvg=$max_contig_cvg
            --insert_size_upper_bound=$insert_size_upper_bound
            --bubble_coverage=$bubble_coverage
            --genome_size=$genome_size
            --ass_visual=$ass_visual
        #end if

        ## Output files
        --contig=$contig
        --scafseq=$scafseq

    </command>
    <inputs>
        <param name="max_read_length"
               type="integer"
               format="input"
               label="Maximum read length"
               value="90"/>
        <repeat name="libraries" title="libraries" min="1">
            <!-- [LIB] -->
            <param name="avg_ins"
                   type="integer"
                   label="Average insert size"
                   value="200"/>
            <param name="reverse_seq"
                   type="select"
                   label="Reverse sequence?"
                   value="0">
                <option value="0">forward-reverse</option>
                <option value="1">reverse-forward</option>
            </param>
            <param name="asm_flags"
                   type="select"
                   label="Which operations should the reads be used for?"
                   value="3">
                <option value="3">For contig and scaffold assembly</option>
                <option value="1">For only contig assembly</option>
                <option value="2">For only scaffold assembly</option>
            </param>
            <param name="rd_len_cutoff"
                   type="integer"
                   label="Input the length of base pairs to use from reads"
                   value="100"/>
            <param name="rank"
                   type="integer"
                   label="Which order are the reads used while scaffolding"
                   value="1"/>
            <param name="pair_num_cutoff"
                   type="integer"
                   label="Pair number cutoff for a reliable connection"
                   value="3"/>
            <param name="map_len"
                   type="integer"
                   label="Length of contig that has to be aligned for a reliable read location"
                   value="32"/>
            <!-- Actual sequence data - can be single or paired reads -->
            <conditional name="data_type">
                <param name="single_paired"
                       type="select"
                       label="What type of data are you using?">
                    <option value="single">Single</option>
                    <option value="paired">Paired</option>
                </param>
                <when value="single">
                    <conditional name="data_format">
                        <param name="fastq_fasta"
                               type="select"
                               label="What type of data are you using?">
                            <option value="fastq">FASTQ</option>
                            <option value="fasta">FASTA</option>
                            <option value="bam">BAM</option>
                        </param>
                        <when value="fastq">
                            <param name="input1"
                                   type="data"
                                   format="input"
                                   label="Forward FASTQ file">
                            </param>
                        </when>
                        <when value="fasta">
                            <param name="input1"
                                   type="data"
                                   format="input"
                                   label="Forward FASTA file">
                            </param>
                        </when>
                        <when value="bam">
                            <param name="input1"
                                   type="data"
                                   format="input"
                                   label="Forward BAM file">
                            </param>
                        </when>
                    </conditional>
                </when>
                <when value="paired">
                    <conditional name="data_format">
                        <param name="fastq_fasta"
                               type="select"
                               label="What is the format of your sequence data?">
                            <option value="fastq">FASTQ</option>
                            <option value="fasta">FASTA</option>
                            <option value="bam">BAM</option>
                        </param>
                        <when value="fastq">
                            <param name="input1"
                                   type="data"
                                   format="input"
                                   label="Forward FASTQ file">
                            </param>
                            <param name="input2"
                                   type="data"
                                   format="input"
                                   label="Reverse FASTQ file">
                            </param>
                        </when>
                        <when value="fasta">
                            <param name="input1"
                                   type="data"
                                   format="input"
                                   label="Forward FASTA file">
                            </param>
                            <param name="input2"
                                   type="data"
                                   format="input"
                                   label="Reverse FASTA file">
                            </param>
                        </when>
                        <when value="bam">
                            <param name="input1"
                                   type="data"
                                   format="input"
                                   label="Forward BAM file">
                            </param>
                            <param name="input2"
                                   type="data"
                                   format="input"
                                   label="Reverse BAM file">
                            </param>
                        </when>
                    </conditional>
                </when>
            </conditional>
        </repeat>
        <!--Other parameters -->
        <conditional name="default_full_settings">
        <param name="settings_type"
               type="select"
               label="SOAP settings to use"
               help="Default settings is suitable for most mapping needs. If you want full control, use Full parameter list">
            <option value="default">Default</option>
            <option value="full">Full parameter list</option>
        </param>
        <when value="default"/>
        <when value="full">
        <!-- Not required
        <param name="config_file"
               type="Plain text"
               label="Configuration information for SOAPdenovo2"/>
         -->
        <param name="kmer_size"
               type="integer"
               value="63"
               label="k value in kmer"
                min="13"
                max="127"/>
        <param name="ncpu"
               type="integer"
               value="8"
               label="Number of CPUs to use"/>
        <param name="init_memory_assumption"
               type="integer"
               label="Initiate the memory assumption to avoid further reallocation, unit G"
                value="0"/>
        <param name="kmer_freq_cutoff"
               type="integer"
               value="0"
               label="Delete kmers with frequency no larger than?"/>
        <param name="resolve_repeats"
               type="select"
               value="NO"
               label="Resolve repeats by reads">
            <option value="NO">No</option>
            <option value="YES">Yes</option>
        </param>
        <param name="edge_cov_cutoff"
               type="integer"
               value="1"
               label="Delete edges with coverage no larger than?"/>
        <param name="merge_level"
               type="select"
               value="1"
               label="Strength of merging similar sequences during contiging">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
        </param>
        <param name="max_k"
               type="integer"
               value="1"
               label="Max k when using multi-kmer"/>
        <param name="weight"
               type="integer"
               value="0"
               label="Weight to filter arc when linearizing two edges"/>
        <param name="keep_avail_read"
               type="text"
               optional="true"
               label="Keep available read (*.read)"/>
        <param name="merge_clean_bubble"
               type="text"
               optional="true"
               label="Merge clean bubble before iterate"/>
        <param name="output_gap_related_reads"
               type="select"
               value="NO"
               optional="true"
               label="Output gap related reads in map step for using SRkgf to fill gap">
            <option value="NO">No</option>
            <option value="YES">Yes</option>
        </param>
        <param name="kmer_r2c"
               type="integer"
               value="13"
               min="13"
               max="63"
               label="kmer size to be used for mapping reads to contigs"/>
        <param name="fill_gaps"
               type="select"
               label="Fill gaps in scaffold">
            <option value="NO">No</option>
            <option value="YES">Yes</option>
        </param>
        <param name="unmask_contigs"
               type="select"
               value="mask"
               optional="true"
               label=" un-mask contigs with high/low coverage before scaffolding">
            <option value="mask">Mask</option>
            <option value="unmask">Unmask</option>
        </param>
        <param name="keep_contigs_connected"
               type="select"
               value="NO"
               label="Keep contigs weakly connected to other contigs in scaffold">
        <option value="NO">No</option>
        <option value="YES">YEs</option>
        </param>
        <param name="gap_len_diff"
               type="integer"
               value="50"
               label="Allowed length difference between estimated and filled gaps"/>
        <param name="min_contig_len"
               type="integer"
               value="20"
               label="Shortest contig for scaffolding"/>
        <param name="min_contig_cvg"
               type="float"
               value="0.1"
               label="Minimum contig coverage (c*avgCvg)"
               help="Contigs shorter than 100bp with coverage smaller than c*avgCvg will be masked before scaffolding unless -u is set"/>
        <param name="max_contig_cvg"
               type="float"
               value="2"
               label="Maximum contig coverage (C*avgCvg)"
               help="Contigs with coverage larger than C*avgCvg or contigs shorter than 100bp with coverage larger than 0.8*C*avgCvg will be masked before scaffolding unless -u is set"/>
        <param name="insert_size_upper_bound"
               type="float"
               value="1.5"
               label="insertSizeUpperBound"
               help="Will be used as upper bound of insert size for large insert size ( > 1000) when handling pair-end connections between contigs if b is set to larger than 1"/>
        <param name="bubble_coverage"
               type="float"
               value="0.6"
               label="Bubble coverage"
               help="Remove contig with lower coverage in bubble structure if both contigs' coverage are smaller than bubbleCoverage*avgCvg"/>
        <param name="genome_size"
               type="integer"
               value="0"
               label="Genome size"
               help="Genome size for statistics"/>
        <param name="ass_visual"
               type="select"
               value="NO"
               optional="true"
               label="Output visualization information of assembly">
            <option value="NO">No</option>
            <option value="YES">Yes</option>
        </param>
        </when>
        </conditional>
    </inputs>
    <outputs>
        <!-- Provide 2 files as output from SOAPdenovo-trans -->
        <data name="contig"
              type="data"
              format="output"
              label="Contig sequence file">
        </data>
        <data name="scafseq"
              type="data"
              format="output"
              label="Scaffold sequence file ">
        </data>
    </outputs>
    <tests>
        <test>
            <param name="max_read_length"
                   value="50"/>
            <output name="contig"
                    value="hello world"/>
        </test>
    </tests>
    <help>

**What it does**

SOAPdenovo is a novel short-read assembly method that can build a de novo draft assembly for the human-sized genomes.
The program is specially designed to assemble Illumina GA short reads. It creates new opportunities for building
reference sequences and carrying out accurate analyses of unexplored genomes in a cost effective way.

-----

**System requirements**

SOAPdenovo is designed for assembling large plant and animal genomes, although it also works well on bacteria and fungal
genomes. It runs on 64-bit/32-bit Linux/MAC OS systems with a minimum of 5G physical memory. For big genomes like human,
approximately 150 GB memory is required.

-----

**Notes**

This Galaxy tool is a wrapping of SOAPdenovo 2.*. This version supports large kmers of up to 127 to utilize long reads.
Changes which have been made to SOAPdenovo include:

1. Merging of the 63mer and 127mer versions.
2. A new module named "sparse-pregraph" has been written which can reduce considerable computational comsumption.
3. The "Multi-kmer" method has been introduced in the "contig" step to allow the utilization of the advantages of small and large kmer.
4. The scaffolding algorithm has been improved to get longer and more accuracy scaffolds.
5. The Asynchronous Input/Output (AIO) was introduced to boost the performance of reading files.
6. Information for visualization purpose has beeb made available after scaffolding.

-----

**Configuring SOAPdenovo2**

For big genome projects with deep sequencing, the data is usually organized as multiple read sequence files generated
from multiple libraries. The configuration file tells the assembler where to find these files and the relevant
information. "example.config" is an example of such a file.

The configuration file has a section for global information, and then multiple library sections. Right now only 
"max_rd_len" is included in the global information section. Any read longer than max_rd_len will be cut to this length.

The library information and the information of sequencing data generated from the library should be organized in the 
corresponding library section. Each library section starts with tag [LIB] and includes the following items:
        
1. avg_ins: This value indicates the average insert size of this library or the peak value position in the insert size distribution figure.

2. reverse_seq: This option takes value 0 or 1. It tells the assembler if the read sequences need to be complementarily reversed. Illumima GA produces two types of paired-end libraries: a) forward-reverse, generated from fragmented DNA ends with  typical insert size less than 500 bp; b) forward-forward, generated from circularizing libraries with typical insertsize greater than 2 Kb. The parameter "reverse_seq" should be set to indicate this: 0, forward-reverse; 1, forward-forward.

3. asm_flags: This indicator decides in which part(s) the reads are used. It takes value 1 (only contig assembly), 2 (only scaffold assembly), 3 (both contig and scaffold assembly), or 4 (only gap closure).

4. rd_len_cutof: The assembler will cut the reads from the current library to this length.

5. rank: It takes integer values and decides in which order the reads are used for scaffold assembly. Libraries with the same "rank" are used at the same time during scaffold assembly.

6. pair_num_cutoff: This parameter is the cutoff value of pair number for a reliable connection between two contigs or pre-scaffolds. The minimum number for paired-end reads and mate-pair reads is 3 and 5 respectively.

7. map_len: This takes effect in the "map" step and is the minimun alignment length between a read and a contig required for a reliable read location. The minimum length for paired-end reads and mate-pair reads is 32 and 35 respectively.

The assembler accepts read files in three kinds of formats: FASTA, FASTQ and BAM. Mate-pair relationship could be 
indicated in two ways: two sequence files with reads in the same order belonging to a pair, or two adjacent reads in a 
single file (FASTA only) belonging to a pair. If a read in bam file fails platform/vendor quality checks(the flag field 
0x0200 is set), itself and it's paired read would be ignored.

In the configuration file single end files are indicated by "f=/path/filename" or "q=/pah/filename" for fasta or fastq 
formats separately. Paired reads in two fasta sequence files are indicated by "f1=" and "f2=". While paired reads in two
fastq sequences files are indicated by "q1=" and "q2=". Paired reads in a single fasta sequence file is indicated by 
"p=" item. Reads in bam sequence files is indicated by "b=".

All the above items in each library section are optional. The assembler assigns default values for most of them. If you 
are not sure how to set a parameter, you can remove it from your configuration file.

-----

**Output files**

Two files are outputted by SOAPdenovo2. The contig file contains sequences without mate pair information. The scafSeq
file contains scaffold portions of the genome which have been reconstructed from contigs and gaps.

-----

**FAQ**

How do I set the K-mer size?

The program accepts odd numbers between 13 and 31. Larger K-mers would have higher rate of uniqueness in the genome and 
would make the graph simpler, but it requires deep sequencing depth and longer read length to guarantee the overlap at
any genomic location.

How do I set the library rank?

SOAPdenovo will use the pair-end libraries with insert size from smaller to larger to construct scaffolds. Libraries 
with the same rank would be used at the same time. For example, in a dataset of a human genome, we set five ranks for 
five libraries with insert size 200-bp, 500-bp, 2-Kb, 5-Kb and 10-Kb, separately. It is desired that the pairs in each
rank provide adequate physical coverage of the genome.

-----

**Format of output files**

*Output files from pregraph*

1. kmerFreq. Each row shows the number of Kmers with a frequency equals the row number. Note that those peaks of frequencies which are the integral multiple of 63 are due to the data structure.
2. edge. Each record gives the information of an edge in the pre-graph: length, Kmers on both ends, average kmer coverage, whether it's reverse-complementarily identical and the sequence.
3. markOnEdge and path. These two files are for using reads to solve small repeats.
4. preArc. Connections between edges which are established by the read paths.
5. vertex. Kmers at the ends of edges.
6. preGraphBasic. Some basic information about the pre-graph: number of vertex, K value, number of edges, maximum read length etc.

*Output files from contig*

1. contig. Contig information: corresponding edge index, length, kmer coverage, whether it's tip and the sequence. Either a contig or its reverse complementry counterpart is included. Each reverse complementary contig index is indicated in the *.ContigIndex file.
2. Arc. Arcs coming out of each edge and their corresponding coverage by reads
3. updated.edge. Some information for each edge in graph: length, Kmers at both ends, index difference between the reverse-complementary edge and this one.
4. ContigIndex. Each record gives information about each contig in the *.contig. it's edge index, length, the index difference between its reverse-complementary counterpart and itself.

*Output files from map*

1. peGrads. Information for each clone library: insert-size, read index upper bound, rank and pair number cutoff for a reliable link. This file can be revised manually for scaffolding tuning.
2. readOnContig. Reads' locations on contigs. Here contigs are referred by their edge index. However, about half of them are not listed in the *.contig file for their reverse-complementary counterparts are included already.
3. readInGap. This file includes reads that could be located in gaps between contigs. This information will be used to close gaps in scaffolds if "-F" is set.

*Output files from scaff*

1. newContigIndex. Contigs are sorted according their length before scaffolding. Their new index are listed in this file.  This is useful if one wants to corresponds contigs in *.contig with those in *.links.
2. links. Links between contigs which are established by read pairs. New index are used.
3. scaf_gap. Contigs in gaps found by contig graph outputted by the contiging procedure. Here new index are used.
4. scaf. Contigs for each scaffold: contig index (concordant to index in *.contig),  approximate start position on scaffold, orientation, contig length, and its links to others contigs.
5. gapSeq. Gap sequences between contigs.
6. scafSeq. Sequences of each scaffolds.
7. contigPosInscaff. Contigs' positions in each scaffold.
8. bubbleInScaff. Contigs that form bubble structures in scaffolds. Every two contigs form a bubble and the contig with higher coverage will be kept in scaffold.
9. scafStatistics. Statistic information of final scaffold and contig.
    </help>
</tool>
